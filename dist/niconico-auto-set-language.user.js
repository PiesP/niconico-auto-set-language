// ==UserScript==
// @name         NicoNico Auto Set Language
// @namespace    https://github.com/PiesP/niconico-auto-set-language
// @version      0.9.1
// @description  Automatically set language to Japanese on NicoNico.
// @match        *://*.nicovideo.jp/*
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_registerMenuCommand
// ==/UserScript==
!function(){"use strict";const e=!0,n=!0,o="ja-jp",t=!1;const i={enabled:"boolean"==typeof(a=GM_getValue("settings",{})).enabled?a.enabled:e,showNotification:"boolean"==typeof a.showNotification?a.showNotification:n,language:"string"==typeof a.language?a.language:o,debug:"boolean"==typeof a.debug?a.debug:t};var a;function u(e){i.debug&&console.log(`[NicoNico Language] ${e}`)}function r(){let e=document.querySelector(".CountrySelector-currentItem"),n=document.querySelector(".CountrySelector-form");if(!e||!n){const o=[".country-selector","[data-language-selector]",'form[action*="language"]','form[action*="lang"]'];for(const t of o){const o=document.querySelector(t);if(o){if("FORM"===o.tagName)n=o;else{const e=o.closest("form");e&&(n=e)}if(e=o.querySelector("[data-value]")||document.querySelector("[data-value]"),n&&e)break}}}return{languageItem:e,languageForm:n}}function c(e,n){if(!e?.getAttribute||!n?.querySelector)return u("언어 선택에 필요한 UI 요소를 찾을 수 없습니다."),!1;try{const o=n.querySelector('input[name="language"]');if(!o)throw new Error("언어 입력 필드를 찾을 수 없습니다.");return e.getAttribute("data-value")===i.language?(u("언어가 이미 일본어로 설정되어 있습니다."),!1):(o.value=i.language,i.showNotification&&g("언어를 일본어로 변경 중입니다..."),n.submit(),!0)}catch(e){return function(e,n){console.error(`[NicoNico Language] ${n}:`,e),i.showNotification&&g(`오류: ${n}`,5e3,"error")}(e,"언어 설정 변경 중 오류 발생"),!1}}function g(e,n=3e3,o="success"){if(!i.showNotification)return;const t=document.createElement("div");t.textContent=e,t.style.cssText=`\n            position: fixed;\n            top: 10px;\n            right: 10px;\n            background: ${"error"===o?"#f44336":"#4CAF50"};\n            color: white;\n            padding: 10px;\n            border-radius: 5px;\n            z-index: 9999;\n            font-family: Arial, sans-serif;\n            box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n        `,document.body.appendChild(t),setTimeout((()=>{t.style.opacity="0",t.style.transition="opacity 0.5s",setTimeout((()=>t.remove()),500)}),n)}function l(){if(!i.enabled)return void u("스크립트가 비활성화되어 있습니다.");if(document.documentElement.lang===i.language&&(u("언어가 이미 일본어로 설정되어 있습니다. 스크립트를 종료합니다."),1))return;const e=r();e.languageItem&&e.languageForm?c(e.languageItem,e.languageForm):(u("언어 선택 요소를 찾을 수 없습니다. DOM 변경 감지를 시작합니다."),function(){if(window._nicoLangObserver)return;const e=new MutationObserver((e=>{window._nicoLangCheckTimeout||(window._nicoLangCheckTimeout=setTimeout((()=>{const e=r();e.languageItem&&e.languageForm&&c(e.languageItem,e.languageForm)&&d(),window._nicoLangCheckTimeout=null}),100))}));e.observe(document.documentElement,{childList:!0,subtree:!0,attributes:!1,characterData:!1}),window._nicoLangObserver=e,window._nicoLangTimeout=setTimeout((()=>{d(),u("언어 요소를 찾을 수 없습니다. 관찰이 타임아웃되었습니다.")}),5e3)}())}function d(){window._nicoLangCheckTimeout&&(clearTimeout(window._nicoLangCheckTimeout),window._nicoLangCheckTimeout=null),window._nicoLangObserver&&(window._nicoLangObserver.disconnect(),window._nicoLangObserver=null),window._nicoLangTimeout&&(clearTimeout(window._nicoLangTimeout),window._nicoLangTimeout=null)}window.addEventListener("unload",(function e(){d(),window._nicoLangCheckTimeout&&(clearTimeout(window._nicoLangCheckTimeout),delete window._nicoLangCheckTimeout),window.removeEventListener("unload",e),delete window._nicoLangObserver,delete window._nicoLangTimeout})),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",l):l(),"function"==typeof GM_registerMenuCommand&&GM_registerMenuCommand("스크립트 활성화/비활성화",(()=>{i.enabled=!i.enabled,GM_setValue("settings",i),g(`스크립트가 ${i.enabled?"활성화":"비활성화"}되었습니다.`),i.enabled&&l()}))}();