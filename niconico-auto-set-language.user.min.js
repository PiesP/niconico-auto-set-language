// ==UserScript==
// @updateURL  https://github.com/PiesP/niconico-auto-set-language/releases/latest/download/niconico-auto-set-language.user.js
// @downloadURL  https://github.com/PiesP/niconico-auto-set-language/releases/latest/download/niconico-auto-set-language.user.js
// @name         NicoNico Auto Set Language
// @namespace    https://github.com/PiesP/niconico-auto-set-language
// @version      0.9.2
// @license      MIT
// @description  Automatically set language to Japanese on NicoNico.
// @match        *://*.nicovideo.jp/*
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_registerMenuCommand
// ==/UserScript==
(()=>{const e="settings",n=!0,t=!0,o="ja-jp",a=!1,u={success:"#4CAF50",error:"#f44336",info:"#2196F3"};let i=d(),l=null,r=null,s=null,c=!1;function d(){const u=GM_getValue(e,{}),i="object"==typeof u&&null!==u?u:{};return{enabled:"boolean"==typeof i.enabled?i.enabled:n,showNotification:"boolean"==typeof i.showNotification?i.showNotification:t,language:"string"==typeof i.language?i.language:o,debug:"boolean"==typeof i.debug?i.debug:a}}function g(e,...n){i.debug&&console.log(`[NicoNico Language] ${e}`,...n)}function f(e,n="success"){if(!i.showNotification)return;if(!document.body)return;const t=document.createElement("div");t.textContent=e,t.style.cssText=`position:fixed;top:10px;right:10px;color:#fff;padding:10px 12px;border-radius:6px;z-index:2147483647;font:13px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;box-shadow:0 2px 10px rgba(0,0,0,.18);background:${u[n]}`,document.body.appendChild(t),window.setTimeout(()=>{t.style.transition="opacity 0.25s",t.style.opacity="0",window.setTimeout(()=>t.remove(),300)},2500)}function m(){null!==s&&(window.clearTimeout(s),s=null),null!==r&&(window.clearTimeout(r),r=null),l&&(l.disconnect(),l=null)}function b(){if(c)return!0;if(!i.enabled)return!1;if(document.documentElement.lang===i.language)return g("Language already matches target.",i.language),!0;const e=function(){const e=document.querySelector('form input[name="language"]');if(!e)return null;const n=e.form??e.closest("form");return n instanceof HTMLFormElement?{form:n,input:e}:null}();if(!e)return!1;try{return e.input.value=i.language,f("Changing language to Japanese...","info"),c=!0,m(),e.form.submit(),!0}catch(e){return console.error("[NicoNico Language] Failed to submit language form:",e),f("Failed to change language.","error"),m(),!1}}function p(){i=d(),c=!1,b()||l||(l=new MutationObserver(()=>{null===s&&(s=window.setTimeout(()=>{s=null,b()&&m()},100))}),l.observe(document.documentElement,{childList:!0,subtree:!0}),r=window.setTimeout(()=>{g("Language form not found within timeout."),m()},5e3))}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",p,{once:!0}):p(),"function"==typeof GM_registerMenuCommand&&GM_registerMenuCommand("Toggle Auto Set Language",()=>{i.enabled=!i.enabled,GM_setValue(e,i),f(`Script ${i.enabled?"enabled":"disabled"}.`,i.enabled?"success":"info"),i.enabled?p():m()})})();